const questionsTest1 = [
  {
    question: "يمثل اللبن ---- من الدخل الزراعي",
    options: ["50%", "25%", "60%", "40%"],
    correctAnswer: "25%",
  },
  {
    question: "ما هي أكبر دولة في إنتاج لبن الجاموس؟",
    options: ["الصين", "الهند", "مصر", "أمريكا"],
    correctAnswer: "الهند",
  },
  {
    question: "يتم إنتاج لبن الأغنام في مصر بنسبة",
    options: ["10%", "5%", "1%", "3%"],
    correctAnswer: "1%",
  },
  {
    question: "يتم إنتاج لبن الماعز بنسبة",
    options: ["2%", "3%", "0.5%", "20%"],
    correctAnswer: "0.5%",
  },
  {
    question: "من أسباب ازدهار صناعة الألبان:",
    options: [
      "التقدم العلمي",
      "قله وسائل النقل",
      "عدم الاهتمام بمراكز التجميع",
      "قله العمالة",
    ],
    correctAnswer: "التقدم العلمي",
  },
  {
    question: "ماهي النسبة المئوية للبن المنتج في المعامل البلدية",
    options: ["20%", "30%", "8%", "1%"],
    correctAnswer: "30%",
  },
  {
    question: "أي العوامل التالية يساعد فى تحسين إنتاج الألبان",
    options: [
      "إهمال صحة المواشى",
      "تقليل عدد مراكز التجميع",
      "الاهتمام بالتحصين الوارش",
    ],
    correctAnswer: "الاهتمام بالتحصين الوارش",
  },
  {
    question: "ما هي الوسيلة للأكثر تأثيراً في رفع جودة الألبان؟",
    options: [
      "إهمال عمليات الحلب",
      "استخدم الحلب الآلى",
      "عدم الاهتمام بالأحلاف",
    ],
    correctAnswer: "استخدم الحلب الآلى",
  },
  {
    question: "ما هي المكونات الأساسية للبن؟",
    options: [
      "ماء - بروتين - دهون - لاكتوز - أملاح معدنية",
      "مينا منينات - بروتين - سكر",
      "بروتين - نشا - ماء",
    ],
    correctAnswer: "ماء - بروتين - دهون - لاكتوز - أملاح معدنية",
  },
  {
    question: "ما هو لون اللبن السرسوبي ؟",
    options: ["أصفر غامق", "بني غامق", "أبيض مصفر", "أبيض غير شفاف"],
    correctAnswer: "أبيض مصفر",
  },
  {
    question: "سبب إحمرار اللبن هو إصابة الحيوان بمرض ؟",
    type: "fill-in-the-blank",
    correctAnswer: "حمى الضرع",
  },
  {
    question:
      "الفرق بين اللبن البقرى واللبن الجاموسى هو أن اللبن البقرى يحتوى على نسبه أقل من؟",
    type: "fill-in-the-blank",
    correctAnswer: "الدهون",
  },
];

const questionsTest2 = [
  {
    question:
      "تختلف نسبة الماء فى الألبان المختلفة فلم يبلغ نسبته فى اللبن الجاموس ؟",
    options: ["80%", "90%", "81.7%", "87.3%"],
    correctAnswer: "81.7%",
  },
  {
    question: "ما هو العنصر الذي يحضر للبن سيولته ؟",
    options: ["اجون", "بروتين", "ماء", "لاكتوز"],
    correctAnswer: "ماء",
  },
  {
    question: "أى من الملونات التالية تتواجد فى اللبن على هيئة مستحلب ؟",
    options: ["ماء", "دهون", "لاكتوز", "ابروسين"],
    correctAnswer: "دهون",
  },
  {
    question: "ما هي نسبة الدهون فى اللبن البقرى ؟",
    options: ["9:6%", "6:3%", "7:5%", "10:8%"],
    correctAnswer: "6:3%",
  },
  {
    question: "نسبة الأحماض الدهنية المشبعة ؟",
    options: ["30%", "20%", "40%", "60%"],
    correctAnswer: "60%",
  },
  {
    question: "نسبة الدهون الحقيقية في اللبن ؟",
    options: ["94%", "98%", "8%", "50%"],
    correctAnswer: "98%",
  },
  {
    question: "أكثر الأحماض الدهنية المتبعة في اللبن هو ؟",
    options: ["محض ليونيك", "الأوليك حمض", "حمض البالمتيك"],
    correctAnswer: "حمض البالمتيك",
  },
  {
    question: "أكثر الأحماض الدهنية الغير مشبعة إنتشار في اللبن ؟",
    options: ["الأوليك", "أركيد ونيك", "بالميتك", "استرك"],
    correctAnswer: "الأوليك",
  },
  {
    question: "أى المركبات التاليه يعد مسئولا عن الطعم الحلو في اللبن ؟",
    options: ["بروتينات", "الأحماض الامينية", "اللاكتوز", " كازين"],
    correctAnswer: "اللاكتوز",
  },
  {
    question: "ما السبب الرئيسي لحدوث التزنخ الأوكسيدى ؟",
    options: [
      "ارتفاع الحرارة",
      "تعرض اللبن للضوء والهواء",
      "انخفاض بنيه الدسم",
    ],
    correctAnswer: "تعرض اللبن للضوء والهواء",
  },
  {
    question: "يعبر رقم كرشنر علي وجود نسبه من حمض ......في اللبن",
    type: "fill-in-the-blank",
    correctAnswer: "البيوتريك",
  },
  {
    question: "يعبر العدد اليودي علي وجود كميه من ..... في اللبن",
    type: "fill-in-the-blank",
    correctAnswer: "الاحماض الدهنيه غير المشبعه",
  },
  {
    question: "يعبر رقم بولنسيكي علي وجود كميه.....في اللبن",
    type: "fill-in-the-blank",
    correctAnswer: "الاحماض دهنيه طياره غير ذائبه",
  },
  {
    question: ".....يحدث التزنخ المائي نتيجه نشاط إنزيم",
    type: "fill-in-the-blank",
    correctAnswer: "الليبيز",
  },
  {
    question: ".....يحدث التزنخ الكيتوني نتيجه نشاط",
    type: "fill-in-the-blank",
    correctAnswer: "الإنزيمات المؤكسده",
  },
];

const questionsTest3 = [
  {
    question: "ما المكون الأساس لبروتينات اللبن ؟",
    options: ["الدهون", "الكربوهيدرات", "الأحماض الأمينية", "المعادن"],
    correctAnswer: "الأحماض الأمينية",
  },
  {
    question: "ها الرقم الهيدروجين الذي يسبب ترسيب الكازين ؟",
    options: ["7.5", "3.2", "4.6", "6.8"],
    correctAnswer: "4.6",
  },
  {
    question: "أي مما يلى يحتوى على نسبة أعلى من الفوسفوري",
    options: ["بروتينات ترش", "الكازين", "اللاكتوز", "الدهون"],
    correctAnswer: "الكازين",
  },
  {
    question: "أي من الطرق التالية تستخدم فى ترسيب الكازين ؟",
    options: ["الطرد المركزي", "تسخين اللبن", "تجميد اللبن", "إضافه الدهون"],
    correctAnswer: "الطرد المركزي",
  },
  {
    question: "ما الإنزيم المستخدم فى ترسيب الكازين فى صناعة اللبن ؟",
    options: ["البيسين", "الرنين", "الأميلتر", "الليبييز"],
    correctAnswer: "الرنين",
  },
  {
    question: "تتحلل اللاكتوز عند تسخينه إلى ؟",
    options: ["جلوكوز و جلاكتوز", "كروز وماء", "جلوكوز فقط", "جلوکوز و فركتوز"],
    correctAnswer: "جلوكوز و جلاكتوز",
  },
  {
    question: "الأشخاص الذين يعانون من حساسية اللاكتوز لديهم نقصافي ؟",
    options: [
      "إنزيم اللاكتوز",
      "إنزيم الأميليز",
      "إنزيم البيسين",
      "إنزيم اللاكتيز",
    ],
    correctAnswer: "إنزيم اللاكتيز",
  },
  {
    question: "يتأثر نشاط إنزيم الفوسفا تيزي ؟",
    options: [
      "انسية الدهون في اللبن",
      "درجة الحرارة",
      "كميه البروتينات",
      "مستوى PH",
    ],
    correctAnswer: "درجة الحرارة",
  },
  {
    question: "ما الإنزيم المسؤول عن محضر سكر الحليب (اللاكتوز)؟",
    options: ["الأميليز", "اللبين", "اللاكتير", "البيسين"],
    correctAnswer: "اللاكتير",
  },
  {
    question: "يستخدم اختبار إنزيم الفوسفاتين لتحديد ؟",
    options: [
      "درجه تجمد اللبن",
      "مدى نجاح عمليه البستره",
      "نسبه السكر فى اللبن",
    ],
    correctAnswer: "مدى نجاح عمليه البستره",
  },
  {
    question: "ما الوظيفه الأساسية الأملاح المعدنيه فى اللبن ؟",
    options: [
      "تحسين اللون",
      "منع التخثر",
      "إعطاء القوام المناسب",
      "توفير العناصر الغذائية مهمه",
    ],
    correctAnswer: "توفير العناصر الغذائية مهمه",
  },
  {
    question: "يعمل إنزيم البلازمين على تحلل ؟",
    options: ["الدهون", "البروتينات", "السكريات", "الأملاح المعدنيه"],
    correctAnswer: "البروتينات",
  },
  {
    type: "fill-in-the-blank",
    question: "إنزيم الليز يقوم بتحليل --- فى اللبن وله دور في تحسين نكهته.",
    correctAnswer: "الدهون",
  },
  {
    type: "fill-in-the-blank",
    question:
      "تسبب درجات الحرارة العاليه فى تغير لون اللبن بين تفاعل اللاكتوز مع",
    correctAnswer: "الأحماض الأمينية",
  },
  {
    type: "fill-in-the-blank",
    question:
      "السكر الذي يعطى اللون البني فى بعض منتجات اللبن التي تتناول بالحراره هو",
    correctAnswer: "اللاكتوز",
  },
];

let currentTest = 0;
let currentQuestionIndex = 0; // مؤشر السؤال الحالي
let score = 0; // درجة المستخدم
let userAnswers = []; // تخزين إجابات المستخدم
let timerInterval; // متغير لتخزين معرف المؤقت

const welcomeContainer = document.querySelector(".welcome-container"); // عنصر يحتوي على شاشة الترحيب
const formContainer = document.querySelector(".form-container"); // عنصر يحتوي على الفورم
const testSelectionContainer = document.querySelector(
  ".test-selection-container"
); // عنصر يحتوي على قائمة الاختبارات
const questionsContainer = document.getElementById("questions-container"); // عنصر يحتوي على الأسئلة
const nextButton = document.getElementById("next-button"); // زر الانتقال للسؤال التالي
const previousButton = document.getElementById("previous-button"); // زر الانتقال للسؤال السابق
const resultContainer = document.getElementById("result"); // عنصر لعرض النتيجة النهائية
const timerElement = document.getElementById("timer"); // عنصر لعرض المؤقت

// إخفاء شاشة الترحيب بعد 3 ثواني وعرض الفورم
setTimeout(() => {
  const storedUsername = localStorage.getItem("username");
  if (!storedUsername) {
    welcomeContainer.classList.add("hidden");
    setTimeout(() => {
      welcomeContainer.style.display = "none";
      formContainer.style.display = "block";
      formContainer.classList.add("visible");
    }, 1300); // تأخير لإخفاء شاشة الترحيب بشكل كامل
  } else {
    // إذا كان اسم المستخدم موجودًا، الانتقال مباشرة إلى قائمة الاختبارات
    welcomeContainer.style.display = "none";
    testSelectionContainer.style.display = "block";
    testSelectionContainer.classList.add("visible");
  }
}, 1500);

document.getElementById("user-form").addEventListener("submit", (e) => {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const namePattern = /^[a-zA-Z\u0600-\u06FF\s]+$/; // نمط للتحقق من أن الاسم يحتوي على حروف فقط (عربية أو إنجليزية)

  if (!namePattern.test(username)) {
    alert("الرجاء إدخال اسم صحيح بدون أرقام.");
    return;
  }

  localStorage.setItem("username", username); // حفظ اسم المستخدم في الذاكرة الداخلية

  formContainer.style.display = "none"; // إخفاء الفورم بدون أنيميشن
  testSelectionContainer.style.display = "block"; // عرض قائمة الاختبارات
  testSelectionContainer.classList.add("visible");

  // تحديث حالة الامتحانات من الذاكرة الداخلية
  updateTestStatus();
});

function goBackToSelection() {
  location.reload(); // إعادة تحميل الصفحة
}

function startTest(testNumber) {
  currentTest = testNumber;
  currentQuestionIndex = 0;
  score = 0;
  userAnswers = [];
  document.body.classList.add("no-background"); // إزالة الخلفية
  testSelectionContainer.style.display = "none"; // إخفاء قائمة الاختبارات
  const container = document.querySelector(".container");
  container.style.display = "block";
  container.classList.add("visible");
  document.getElementById("back-to-selection-button").style.display = "block"; // عرض زر العودة
  startTimer(60 * 60); // بدء المؤقت لمدة ساعة واحدة (3600 ثانية)
  showQuestion(currentQuestionIndex);
}

function startTimer(duration) {
  let timer = duration,
    minutes,
    seconds;
  timerInterval = setInterval(() => {
    minutes = parseInt(timer / 250, 10);
    seconds = parseInt(timer % 60, 10);

    minutes = minutes < 10 ? "0" + minutes : minutes;
    seconds = seconds < 10 ? "0" + seconds : seconds;

    timerElement.textContent = minutes + ":" + seconds;

    if (--timer < 0) {
      clearInterval(timerInterval);
      showResult(); // عرض النتيجة النهائية عند انتهاء الوقت
    }
  }, 1000);
}

function showQuestion(index) {
  questionsContainer.innerHTML = ""; // تفريغ محتوى عنصر الأسئلة
  const questions =
    currentTest === 1
      ? questionsTest1
      : currentTest === 2
      ? questionsTest2
      : questionsTest3;
  const question = questions[index]; // الحصول على السؤال الحالي
  const questionDiv = document.createElement("div"); // إنشاء عنصر جديد للسؤال
  questionDiv.classList.add("question"); // إضافة فئة CSS للسؤال

  const questionTitle = document.createElement("h2"); // إنشاء عنصر لعنوان السؤال
  questionTitle.textContent = question.question; // تعيين نص السؤال
  questionTitle.style.textAlign = "center"; // محاذاة النص إلى الوسط
  questionDiv.appendChild(questionTitle); // إضافة عنوان السؤال إلى عنصر السؤال

  if (question.type === "fill-in-the-blank") {
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "اكتب إجابتك هنا";
    input.style.display = "block"; // عرض الحقل ككتلة
    input.style.margin = "20px auto"; // تباعد داخلي للحقل
    input.style.padding = "10px"; // تباعد داخلي للحقل
    input.style.width = "80%"; // عرض الحقل
    input.style.borderRadius = "4px"; // حواف دائرية للحقل
    input.style.border = "1px solid #ccc"; // حدود الحقل
    input.value = userAnswers[index] || ""; // استرجاع الإجابة السابقة إذا كانت موجودة
    input.addEventListener("input", () => {
      userAnswers[index] = input.value; // تخزين إجابة المستخدم
      nextButton.disabled = !input.value.trim(); // تعطيل الزر إذا لم يتم إدخال إجابة
    });
    questionDiv.appendChild(input);
  } else {
    const optionsDiv = document.createElement("div"); // إنشاء عنصر جديد للخيارات
    optionsDiv.classList.add("options"); // إضافة فئة CSS للخيارات

    question.options.forEach((option) => {
      const button = document.createElement("button"); // إنشاء زر لكل خيار
      button.textContent = option; // تعيين نص الخيار
      if (userAnswers[index] === option) {
        button.classList.add("selected"); // تحديد الإجابة السابقة إذا كانت موجودة
      }
      button.addEventListener("click", () => {
        // إضافة مستمع للنقر على الزر
        userAnswers[index] = option; // تخزين إجابة المستخدم
        document.querySelectorAll(".options button").forEach((btn) => {
          btn.classList.remove("selected"); // إزالة الفئة من جميع الأزرار
        });
        button.classList.add("selected"); // إضافة الفئة للزر المحدد
        nextButton.disabled = false; // تمكين زر "السؤال التالي"
      });
      optionsDiv.appendChild(button); // إضافة الزر إلى عنصر الخيارات
    });

    questionDiv.appendChild(optionsDiv); // إضافة عنصر الخيارات إلى عنصر السؤال
  }

  questionsContainer.appendChild(questionDiv); // إضافة عنصر السؤال إلى عنصر الأسئلة

  // عرض زر "السؤال السابق" إذا لم يكن السؤال الأول
  previousButton.style.display = index > 0 ? "block" : "none";

  // تمكين أو تعطيل زر "السؤال التالي" بناءً على الإجابة
  nextButton.disabled = !userAnswers[index];
  nextButton.style.display = "block"; // التأكد من أن الزر ظاهر دائمًا
}

previousButton.addEventListener("click", () => {
  // التأكد من أن المؤشر أكبر من الصفر
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--; // تقليل المؤشر بمقدار واحد
    showQuestion(currentQuestionIndex); // عرض السؤال بناءً على المؤشر الجديد
  }
});

nextButton.addEventListener("click", () => {
  // إضافة مستمع للنقر على زر "السؤال التالي"
  const questions =
    currentTest === 1
      ? questionsTest1
      : currentTest === 2
      ? questionsTest2
      : questionsTest3;

  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++; // زيادة مؤشر السؤال الحالي بمقدار واحد
    showQuestion(currentQuestionIndex); // عرض السؤال التالي بناءً على المؤشر الجديد
  } else {
    showResult(); // عرض النتيجة النهائية إذا كان المستخدم في آخر سؤال
  }
});

function showResult() {
  clearInterval(timerInterval); // إيقاف المؤقت
  questionsContainer.style.display = "none"; // إخفاء عنصر الأسئلة
  nextButton.style.display = "none"; // إخفاء زر الانتقال للسؤال التالي
  resultContainer.style.display = "block"; // عرض عنصر النتيجة النهائية

  let resultHTML = `<h2>نتائج الاختبار</h2>`;
  const questions =
    currentTest === 1
      ? questionsTest1
      : currentTest === 2
      ? questionsTest2
      : questionsTest3;
  questions.forEach((question, index) => {
    const userAnswer = userAnswers[index];
    const correctAnswer = question.correctAnswer;
    const isCorrect = userAnswer === correctAnswer;
    if (isCorrect) score++;
    resultHTML += `
      <div class="result-question">
        <h3>${question.question}</h3>
        <p>إجابتك: ${userAnswer} ${isCorrect ? "(صحيحة)" : "(خاطئة)"}</p>
        ${!isCorrect ? `<p>الإجابة الصحيحة: ${correctAnswer}</p>` : ""}
      </div>
    `;
  });

  resultHTML += `<p>لقد أجبت بشكل صحيح على ${score} من ${questions.length} أسئلة.</p>`;
  resultContainer.innerHTML = resultHTML;

  const submitButton = document.createElement("button");
  submitButton.id = "submit-button";
  submitButton.textContent = "تسليم الاختبار";
  submitButton.addEventListener("click", handleSubmit);
  resultContainer.appendChild(submitButton);

  const backButton = document.createElement("button");
  backButton.id = "back-to-main-menu-button";
  backButton.textContent = "الرجوع إلى القائمة الرئيسية";
  backButton.style.backgroundColor = "#ffcc00"; // لون مميز للزر
  backButton.style.color = "#121212"; // لون النص
  backButton.addEventListener("click", () => {
    location.reload(); // إعادة تحميل الصفحة
  });
  resultContainer.appendChild(backButton);
}

function handleSubmit() {
  if (navigator.onLine) {
    sendEmail(stripHTML(resultContainer.innerHTML));
    resultContainer.innerHTML += `<p style="color: green; font-weight: bold;">تم إرسال الإجابات بنجاح.</p>`;
    document.getElementById(`test${currentTest}-status`).textContent =
      "الحالة: تم الامتحان";
    document
      .getElementById(`test${currentTest}-status`)
      .classList.remove("status-not-done");
    document
      .getElementById(`test${currentTest}-status`)
      .classList.add("status-done");
    document.getElementById(`test${currentTest}-status`).style.color = "green";
    localStorage.setItem(`test${currentTest}-status`, "تم الامتحان");
  } else {
    alert("أنت لست متصل بالإنترنت، لم يتم تسليم الاختبار.");
  }

  document.getElementById("back-to-main-menu-button").style.display = "none"; // إخفاء زر الرجوع إلى القائمة الرئيسية

  let countdown = 5;
  const countdownElement = document.createElement("p");
  countdownElement.style.color = "red";
  countdownElement.style.fontWeight = "bold";
  resultContainer.appendChild(countdownElement);

  const countdownInterval = setInterval(() => {
    countdownElement.textContent = `سيتم ارجاعك الى القائمة الرئيسية خلال ${countdown} ثواني`;
    countdown--;
    if (countdown < 0) {
      clearInterval(countdownInterval);
      location.reload(); // إعادة تحميل الصفحة
    }
  }, 1000); // عداد 5 ثواني
}

function resetTest() {
  currentTest = 0;
  currentQuestionIndex = 0;
  score = 0;
  userAnswers = [];
  questionsContainer.innerHTML = "";
  nextButton.style.display = "none";
  resultContainer.innerHTML = "";
  document.body.classList.remove("no-background"); // إعادة الخلفية
}

function stripHTML(html) {
  const tmp = document.createElement("DIV");
  tmp.innerHTML = html;
  return tmp.textContent || tmp.innerText || "";
}

function sendEmail(resultText) {
  const username = localStorage.getItem("username"); // استرجاع اسم المستخدم من الذاكرة الداخلية
  const templateParams = {
    to_email: "yta861356@gmail.com",
    from_name: username,
    message: `اسم الطالب: ${username}\n${resultText}`,
  };

  fetch("https://api.emailjs.com/api/v1.0/email/send", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      service_id: "service_hufi8li",
      template_id: "template_1iaohnh",
      user_id: "hX0tBR1huam3gEj78",
      template_params: templateParams,
    }),
  })
    .then((response) => {
      if (response.ok) {
        console.log("SUCCESS!", response.status, response.text());
      } else {
        console.log("FAILED...", response.status, response.text());
      }
    })
    .catch((error) => {
      console.log("FAILED...", error);
    });
}

function updateTestStatus() {
  for (let i = 1; i <= 3; i++) {
    const status = localStorage.getItem(`test${i}-status`);
    if (status) {
      document.getElementById(
        `test${i}-status`
      ).textContent = `الحالة: ${status}`;
      if (status === "تم الامتحان") {
        document.getElementById(`test${i}-status`).style.color = "green";
      } else {
        document.getElementById(`test${i}-status`).style.color = "red";
      }
    } else {
      document.getElementById(`test${i}-status`).textContent =
        "الحالة: لم يتم الامتحان";
      document.getElementById(`test${i}-status`).style.color = "red";
    }
  }
}

window.addEventListener("online", () => {
  for (let i = 1; i <= 3; i++) {
    const storedAnswers = localStorage.getItem(`userAnswersTest${i}`);
    if (storedAnswers) {
      sendEmail(stripHTML(storedAnswers));
      localStorage.removeItem(`userAnswersTest${i}`);
      document.getElementById(`test${i}-status`).textContent =
        "الحالة: تم الامتحان";
      document.getElementById(`test${i}-status`).style.color = "green";
    }
  }
});

// تحديث حالة الامتحانات عند تحميل الصفحة
updateTestStatus();

// التحقق من وجود اسم المستخدم في الذاكرة الداخلية وعرض قائمة الاختبارات مباشرة إذا كان موجودًا
window.addEventListener("load", () => {
  const storedUsername = localStorage.getItem("username");
  if (storedUsername) {
    document.getElementById("username").value = storedUsername;
    welcomeContainer.style.display = "none";
    formContainer.style.display = "none"; // إخفاء الفورم
    testSelectionContainer.style.display = "block";
    testSelectionContainer.classList.add("visible");
  }
});

function logout() {
  localStorage.clear(); // حذف جميع البيانات المخزنة في الذاكرة الداخلية
  location.reload(); // إعادة تحميل الصفحة
}
